{{- if .Values.repo }}
{{- range $env := .Values.environments }}
{{- if ne $env.name "prod" }}  # non-prod only
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: "deployment-{{ $.Values.workloadName }}-{{ $env.name }}"
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error

  generators:
    - git:
        repoURL: "{{ $.Values.repo }}"
        revision: HEAD
        directories:
          # webstore/<service>/<env>, e.g. webstore/ui/dev
          - path: "{{ $.Values.workloadName }}/*/{{ $env.name }}"

  template:
    metadata:
      # path example: webstore/catalog/dev
      # parts: ["webstore", "catalog", "dev"]
      name: "{{ $.Values.workloadName }}-{{`{{ index (splitList \"/\" .path) 1 }}`}}-{{ $env.name }}"
      labels:
        workload: "{{ $.Values.workloadName }}"
        service: "{{`{{ index (splitList \"/\" .path) 1 }}`}}"
        env: "{{ $env.name }}"

    spec:
      project: "{{ $.Values.project | default "default" }}"

      source:
        repoURL: "{{ $.Values.repo }}"
        targetRevision: HEAD
        path: "{{`{{ .path }}`}}"

      destination:
        # ðŸ”¹ per-env cluster from environments.json
        name: "{{ $env.cluster }}"
        # ðŸ”¹ namespace pattern per env (your namespaces AppSet already creates these)
        namespace: "{{ $.Values.workloadName }}-{{ $env.name }}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
{{- end }}
{{- end }}
{{- end }}
