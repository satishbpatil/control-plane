{{- if .Values.repo }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: "deployment-{{ .Values.workloadName }}-nonprod"
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error

  # ------------------------------------------
  # 1. Data-driven env â†’ cluster mapping
  # ------------------------------------------
  generators:
    - list:
        elements:
{{- range .Values.environments }}
{{- if ne .name "prod" }}        # only non-prod envs
          - env: {{ .name | quote }}
            cluster: {{ .cluster | quote }}
{{- end }}
{{- end }}

  # ------------------------------------------
  # 2. One Application per environment
  # ------------------------------------------
  template:
    metadata:
      # e.g. webstore-dev, webstore-stage
      name: "{{ .Values.workloadName }}-{{`{{ .env }}`}}"
      labels:
        workload: "{{ .Values.workloadName }}"
        env: "{{`{{ .env }}`}}"

    spec:
      project: "{{ .Values.project | default "default" }}"

      source:
        # ðŸ”¹ apps repo from environments.json / values
        repoURL: "{{ .Values.repo }}"
        targetRevision: HEAD
        # adjust this to your repo layout
        # example: webstore/dev, webstore/stage, etc.
        path: "{{ .Values.workloadName }}/{{`{{ .env }}`}}"

      destination:
        # ðŸ”¹ cluster comes from environments.json
        name: "{{`{{ .cluster }}`}}"
        # per-env namespace, e.g. webstore-dev, webstore-stage
        # namespace: "{{ .Values.workloadName }}-{{`{{ .env }}`}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
{{- end }}
