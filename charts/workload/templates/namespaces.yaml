apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: workload-{{ .Values.workloadName }}-namespace
  namespace: argocd
spec:
  generators:
    - cluster:
    
    - git:
        repoURL: https://github.com/satishbpatil/control-plane
        revision: main
        directories:
        - path: ../../workload/*/git-generator-directory/cluster-addons/*

  template:
    metadata:
      name: "workload-{{ .Values.workloadName }}-namespace-{{ env }}"
      namespace: argocd
      labels:
        workload: "{{ .Values.workloadName }}"
        environment: "{{ env }}"
        cluster: "{{ cfg.cluster.name }}"

    spec:
      project: {{ .Values.project | default "default" }}

      source:
        repoURL: https://github.com/satishbpatil/control-plane
        targetRevision: main
        path: charts/namespace
        helm:
          valueFiles:
            # always include default
            - config/{{ .Values.workloadName }}/default-namespace.yaml

            # optional env-specific override (ignored if missing)
            - config/{{ .Values.workloadName }}/{{ env }}/namespace.yaml

          parameters:
            - name: workloadName
              value: "{{ .Values.workloadName }}"
            - name: environment
              value: "{{ env }}"

            # metadata extracted from config.json
            - name: awsAccount
              value: "{{ cfg.aws_account }}"
            - name: assetId
              value: "{{ cfg.asset_id }}"
            - name: clusterName
              value: "{{ cfg.cluster.name }}"
            - name: clusterOwner
              value: "{{ cfg.cluster.owner }}"

      # Namespace resource is cluster-scoped â†’ only set cluster destination
      destination:
        server: "{{ cfg.cluster.address }}"

  templateParameters:
    # env = the parent folder name of config.json
    - name: env
      value: '{{ path | dirname | basename }}'

    # cfg = parsed JSON contents of the config file
    - name: cfg
      value: '{{ file.Read path | fromJson }}'
